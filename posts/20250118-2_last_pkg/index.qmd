---
title: "R CRAN Packages (2/5)"
author: "Alcor"
date: "2025-01-18"
categories: [news, code, analysis]
image: "image.jpg"
---

## Last R packages published yesterday

```{r}
#| label: load_libraries
#| code-fold: true
#| warning: false
#| 
library(purrr)
library(tools)
library(dplyr)
library(tibble)
library(lubridate)
library(gt)
library(glue)
library(RPostgres)

```

### Récupération des données `packages` du CRAN

```{r}
#| label: CRAN_package_db
#| 
pdb <- tools::CRAN_package_db()

```

### Derniers paquets publiés la veille

On se base sur la date de publication issue du timestamp provenant du champ `Date\Publication`
  
```{r}
#| label: published_field
#| code-fold: true

cran_repo <- "https://cran.r-project.org/web/packages/"

last_pkg_published <- pdb |> 
  select(Package, Version, `Date/Publication`) |> 
  filter(
    date(ymd_hms(`Date/Publication`)) == (Sys.Date() - 1)
  ) |> 
  arrange(desc(`Date/Publication`), Package, Version) |>
  rename(
    paquet = Package,
    version = Version,
    date_publication = `Date/Publication`
  ) |> 
  mutate(lien = paste0(cran_repo, paquet),
    lien = glue::glue("[{paquet}]({lien})"))
         
gt_last_pkg_published <- last_pkg_published |> 
  mutate(lien = map(lien, md)) |> 
  gt() |>   
  tab_header(
    title    = md("**Derniers paquets publiés**"),
    subtitle  = md(paste("Total =", nrow(last_pkg_published))),
  ) 

gt_last_pkg_published

```

### Sauvegarde des derniers paquets publiés

  1 .Etablissement de la connexion `postgresql`
  
```{r}
#| label: create_conn
#| code-fold: true

DB_HOSTNAME <- Sys.getenv("DB_HOSTNAME")
DB_USER <- Sys.getenv("DB_USER")
DB_PASSWORD <- Sys.getenv("DB_PASSWORD")
DB_PORT <- Sys.getenv("DB_PORT")
DB_NAME <- Sys.getenv("DB_NAME")

conn <- RPostgres::dbConnect(
  drv = RPostgres::Postgres(), 
  dbname = DB_NAME,
  host = DB_HOSTNAME,
  port = DB_PORT,
  user = DB_USER,
  password = DB_PASSWORD
)

```
  
  2. Bascule sur le schéma `dev` par défaut
  
```{r}
#| label: set_schema_default
#| code-fold: true
#| message: false

query <- paste(
  "ALTER DATABASE",
  DB_NAME,
  "SET SEARCH_PATH TO dev;"
)
RPostgres::dbSendQuery(
  conn,
  query
)

```

  3. Ajout des nouveaux paquets R à la table `paquets`

::: {.callout-note collapse="false"}

La table `paquets` a été créée en avance de phase avec les requêtes SQL :

```SQL
CREATE SCHEMA dev;

CREATE TABLE dev.paquets(
  id SERIAL PRIMARY KEY,
  paquet VARCHAR(50) NOT NULL,
  version VARCHAR(20) NOT NULL,
  date_publication TIMESTAMP NOT NULL, 
  lien VARCHAR(100),
  UNIQUE(paquet, version));
```
:::

```{r}
#| label: add_info_last_pkg_to_psql_table
#| code-fold: true
#| message: false
#| 
RPostgres::dbAppendTable(
  conn = conn, 
  name = Id(schema = 'dev', table = 'paquets'), 
  value = last_pkg_published
)

```

  4. Vérification des ajouts d'information dans la table `paquets`

```{r}
#| label: verif_data_inserted
#| code-fold: true
#| message: false

request <- "SELECT COUNT(DISTINCT paquet) AS total_paquets
            FROM paquets";

total_paquets <- RPostgres::dbGetQuery(conn, statement = request)$total_paquets

request <- "SELECT MAX(date_publication::date) -
                   MIN(date_publication::date) + 
                   1 AS duree
           FROM paquets;"

duree <- RPostgres::dbGetQuery(conn, statement = request)$duree

request <- "SELECT count(paquet) AS nb_paquets, date_publication::date,
            SUM(COUNT(paquet)) OVER (ORDER BY date_publication::date) AS total
            FROM dev.paquets
            GROUP BY date_publication::date;"

result <- RPostgres::dbGetQuery(conn, statement = request)

gt(result) |> tab_header(
  title    = md(paste("**Total des versions de paquets sur", duree, "jours**")),
  subtitle = md(paste("(sur", total_paquets, "paquets versionnés)"))
)

```

  5. Sélection des paquets ayant été versionné plus d'une fois depuis

```{r}
#| label: verif_data_inserted
#| code-fold: true
#| message: false

request <- "SELECT MIN(date_publication)::date AS date_min
            FROM paquets;"

date_min <- RPostgres::dbGetQuery(conn, statement = request)$date_min

request <- "SELECT paquet, version, date_publication, 
           RANK() OVER(PARTITION BY paquet ORDER BY version) AS revision 
           FROM paquets 
           WHERE paquet IN (
	           SELECT paquet 
	           FROM (
		           SELECT COUNT(*), paquet 
		           FROM paquets 
		           GROUP by paquet 
		       HAVING COUNT(*) > 1
	           )
           );"

result <- RPostgres::dbGetQuery(conn, statement = request)

gt(result) |> 
  tab_header(
    title    = md("**Paquets versionnés plus d'une fois**"),
    subtitle = md(paste0("(depuis le ", as.Date(date_min), ")"))
  )

```

  6. Déconnexion

```{r}
#| label: dbDisconnect
#| code-fold: true
#| message: false

RPostgres::dbDisconnect(conn)

```

