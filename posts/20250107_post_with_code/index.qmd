---
title: "R packages database"
author: "Alcor"
date: "2025-01-07"
categories: [news, code, analysis]
image: "image.jpg"
---

## Paquets R

```{r}
#| label: load_libraries
#| code-fold: true
#| warning: false
#| 
library(purrr)
library(dplyr)
library(gt)
library(tools)
library(lobstr)
library(tibble)

```

### Nombre de paquets R disponibles

  - utilisation de la fonction **`available.packages`** du paquet `utils`
  
```{r}
#| label: available_packages
#| 
mat_pkg <- utils::available.packages()
#head.matrix(mat_pkg)
tbl_pkg <- tibble::as_tibble(mat_pkg)

```

  - Utilisation de la fonction `CRAN_package_db` du paquet **`tools`**

```{r}
#| label: CRAN_package_db
#| 
pkgdb <- tools::CRAN_package_db()

```

  - comparaisons du nombre d'informations entre les 2 bases

```{r}
#| label: db_comparisons
#| code-fold: true

tbl_summary <- tibble(
             n = c(length(unique(tbl_pkg$Package)), 
                   length(unique(pkgdb$Package))),
  fields_count = c(ncol(tbl_pkg), ncol(pkgdb)), 
        taille = c(lobstr::obj_size(tbl_pkg), lobstr::obj_size(pkgdb)) 
)

gt_summary <- gt(tbl_summary) |> 
  tab_header(
    title = md("**packages R disponibles**"),
    subtitle = md(paste("(en date du", Sys.Date(), ")"))
  ) |> 
  tab_footnote(
    footnote = md("Quantité estimée avec la commande `obj_size`"),
    locations = cells_column_labels(columns = taille)
  ) |> 
  tab_footnote(
    footnote = md("Données issues de la commande `available.packages`"),
    locations = cells_body(
      columns = c(fields_count,n), rows = 1
    )
  ) |> 
  tab_footnote(
    footnote = md("Données issues de la commande `CRAN_package_db`"),
    locations = cells_body(
      columns = c(fields_count,n), rows = 2
    )
  )

gt_summary

```

### Paquets communs

```{r}
#| label: similar_pkgs
#| code-fold: true

similar_pkgs <- intersect(tbl_pkg$Package, pkgdb$Package)

```

::: {.callout-note collapse="false"}

 - Nous avons `r length(similar_pkgs)` paquets en commun

 - Tous les paquets du tibble `tbl_pkg` sont présents dans le data.frame `pkgdb` puisque :

   - **length(tbl_pkg\$Package[!tbl_pkg\$Package %in% similar_pkgs]) == `r length(tbl_pkg$Package[!tbl_pkg$Package %in% similar_pkgs])`**

:::

### Paquets différents

```{r}
#| label: dissimilar_pkgs
#| code-fold: true

dissimilar_pkgs <- pkgdb$Package[!pkgdb$Package %in% similar_pkgs]
dissimilar_pkgs

```

### Paquets doublons

```{r}
#| label: twin_pkgs
#| code-fold: true

pkgdb |>
  summarize(n = dplyr::n(), .by = Package) |> 
  dplyr::filter(n > 1) |> 
  dplyr::inner_join(pkgdb) |> 
  dplyr::select(c(Package, Version, Depends)) 

```

### Informations communes et différentes

  - Champs communs
  
```{r}
#| label: similar_fields
#| code-fold: true
#| 
similar_fields <- names(tbl_pkg)[names(tbl_pkg) %in% names(pkgdb)]
similar_fields

```

  - Champs différents
  
```{r}
#| label: dissimilar_fields
#| code-fold: true
#| 
dissimilar_fields_tbl_pkg <- names(tbl_pkg)[!names(tbl_pkg) %in% names(pkgdb)]
dissimilar_fields_pkgdb <- names(pkgdb)[!names(pkgdb) %in% names(tbl_pkg)]
dissimilar_fields <- c(dissimilar_fields_tbl_pkg, dissimilar_fields_pkgdb)
dissimilar_fields

```

### Informations sur les champs

::: {.callout-note collapse="false"}

Tous les données des contenues dans `tbl_pkg` et `pkgdb` sont de type **character**

On peut donc calculer la taille maximale de caractères utilisés pour les données de chaque champ.

:::

```{r}
#| label: fields_info
#| code-fold: true
#| 
get_property <- function(tbl, f) sapply(tbl, f)

get_NA_count <- function(x) sum(is.na(x))
get_data_count <- function(x) sum(!is.na(x))
get_unique_count <- function(x) length(unique(x[!is.na(x)]))
get_max_nchar <- function(x) {
  if (all(is.na(x))) return(0) else return(max(nchar(x[!is.na(x)])))
}

get_gt_summary <- function(tbl) {
  
  data_count <- tbl |> get_property(get_data_count)
  NA_count <- tbl |> get_property(get_NA_count)
  unique_count <- tbl |> get_property(get_unique_count)
  max_nchar <- tbl |> get_property(get_max_nchar)
  
  resultat <- t(rbind(data_count, NA_count, unique_count, max_nchar))

  tbl_summary <- as_tibble(resultat)
  tbl_summary$field <- dimnames(resultat)[[1]]
  tbl_summary <- tbl_summary |> 
    dplyr::relocate("field")

  names(tbl_summary) <- c("Nom du champ", 
                          "# lignes avec données", 
                          "# lignes avec NA", 
                          "# valeurs différentes", 
                          "taille max.")

  gt_summary <- gt(tbl_summary) |> 
    tab_header(
      title = md("Données relatives aux différents champs"),
      subtitle = md(paste("Nombre de lignes = ", nrow(tbl)))
  ) |> 
  tab_footnote(
    footnote = md("La valeur NA n'est pas comptabilisée"),
    locations = cells_column_labels(columns = "# valeurs différentes")
  ) |> 
  tab_footnote(
    footnote = md("En nombre de caractères (0 si NA pour toutes les lignes)"),
    locations = cells_column_labels(columns = "taille max.")
  )

  return(gt_summary)
  
}

```

  -  de la table `tbl_pkg`

```{r}
#|label: summary_tbl_pkg

gt_summary_tbl_pkg <- get_gt_summary(tbl_pkg)
gt_summary_tbl_pkg

```

  - de la table `pgkdb`

```{r}
#|label: summary_pkgdb

gt_summary_pkgdb <- get_gt_summary(pkgdb)
gt_summary_pkgdb

```

### Types de licences utilisées

```{r}
#| label: licences_used
#| code-fold: true
#| warning: false

table_licenses <- table(tbl_pkg$License)
mat_licenses <- as.matrix(table_licenses)
tbl_licenses <- as_tibble(mat_licenses)
tbl_licenses$license <- dimnames(mat_licenses)[[1]]
tbl_licenses <- tbl_licenses |> 
  dplyr::relocate("license")

names(tbl_licenses) <- c("Nom licence", "occurrences")

```

  - Licences à usage unique

```{r}
#|label: orphan_licenses

tbl_orphan_licenses <- tbl_licenses |> 
    dplyr::filter(occurrences == 1) |> 
    left_join(tbl_pkg, join_by("Nom licence" == License)) |> 
    select(Package, "Nom licence")

gt_orphan_licenses <- gt(tbl_orphan_licenses) |> 
  tab_header(
    title = md("**Licences orphelines**"),
    subtitle = md("(occurrence de licence égale à 1 pour un paquet donné)")
  ) 

gt_orphan_licenses
```

  - Autres licences

```{r}
#|label: other_licenses

tbl_other_licenses <- tbl_licenses |> 
  filter(occurrences > 1)

gt_other_licenses <- gt(tbl_other_licenses) |> 
  tab_header(
    title = md("**Licences non orphelines**"),
    subtitle = md("(occurrences de licence supérieure à 1 pour un paquet donné)")
  ) 

gt_other_licenses

```


